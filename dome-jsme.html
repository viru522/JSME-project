<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stator Winding Data</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { background: #f8f9fa; padding: 25px; }
    .card { max-width: 900px; margin: auto; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .pitch-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 8px; }
    .pitch-row input { flex: 1; min-width: 100px; }
    .remove { font-size: 18px; line-height: 1; }
    #preview { max-width: 200px; margin-top: 10px; display: block; }
  </style>
</head>

<body>
  <div class="card p-4">
    <h3 class="mb-3 text-center text-primary">‚öôÔ∏è Stator Winding Data Entry</h3>
    <form id="entryForm">
      <div class="row mb-3">
        <div class="col-md-4"><input type="date" id="date" class="form-control" required></div>
        <div class="col-md-8"><input type="text" id="name" class="form-control" placeholder="Motor Name" required></div>
      </div>
      <div class="row mb-3">
        <div class="col-md-3"><input type="text" id="type" class="form-control" placeholder="Type"></div>
        <div class="col-md-2"><input type="text" id="phase" class="form-control" placeholder="Phase"></div>
        <div class="col-md-2"><input type="text" id="hp" class="form-control" placeholder="HP"></div>
        <div class="col-md-2"><input type="text" id="kw" class="form-control" placeholder="KW"></div>
        <div class="col-md-3"><input type="text" id="rpm" class="form-control" placeholder="RPM"></div>
      </div>

      <div class="mb-3">
        <label class="form-label">Upload Winding / Nameplate Image</label>
        <input type="file" id="image" class="form-control" accept="image/*">
        <img id="preview" src="" alt="">
      </div>

      <h6 class="mt-3 text-primary">Starting Pitch</h6>
      <div id="startingPitches"></div>
      <button type="button" id="addStart" class="btn btn-sm btn-outline-primary mb-2">+ Add Start Pitch</button>

      <h6 class="text-primary">Running Pitch</h6>
      <div id="runningPitches"></div>
      <button type="button" id="addRun" class="btn btn-sm btn-outline-primary mb-3">+ Add Run Pitch</button>

      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-success">üíæ Save Entry</button>
        <button type="button" id="exportBtn" class="btn btn-secondary">üì§ Export All to Excel</button>
      </div>
    </form>
  </div>

  <div class="card mt-4 p-3">
    <h5 class="text-center text-primary">üìã All Saved Entries</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-striped mt-3" id="dataTable">
        <thead class="table-light">
          <tr>
            <th>Date</th><th>Name</th><th>Type</th><th>Phase</th><th>HP</th><th>KW</th><th>RPM</th>
            <th>Starting Pitches</th><th>Running Pitches</th><th>Image</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const startDiv = document.getElementById("startingPitches");
    const runDiv = document.getElementById("runningPitches");
    const tableBody = document.querySelector("#dataTable tbody");
    const entries = [];

    function addPitch(container) {
      const row = document.createElement("div");
      row.className = "pitch-row";
      row.innerHTML = `
        <input type="number" step="0.1" class="form-control pitch-set" placeholder="Set">
        <input type="number" class="form-control pitch-turns" placeholder="Turns">
        <input type="text" class="form-control pitch-gauge" placeholder="Gauge">
        <input type="number" step="0.01" class="form-control pitch-weight" placeholder="Weight (kg)">
        <button type="button" class="btn btn-sm btn-outline-danger remove">&times;</button>
      `;
      row.querySelector(".remove").onclick = () => row.remove();
      container.appendChild(row);
    }

    document.getElementById("addStart").onclick = () => addPitch(startDiv);
    document.getElementById("addRun").onclick = () => addPitch(runDiv);
    addPitch(startDiv);
    addPitch(runDiv);

    const imageInput = document.getElementById("image");
    const preview = document.getElementById("preview");
    imageInput.onchange = () => {
      const file = imageInput.files[0];
      if (file) preview.src = URL.createObjectURL(file);
    };

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyT5aUQoeEGflxVv0oNjAYycV_s9L-wMm5hmKlgygLMCY5rj9ZPAOvlGmQyG7vriPtTiw/exec"; // Replace with your Web App URL

    document.getElementById("entryForm").onsubmit = async (e) => {
      e.preventDefault();

      const getPitchData = (container) => [...container.children].map(r => ({
        set: parseFloat(r.querySelector(".pitch-set").value) || 0,
        turns: parseInt(r.querySelector(".pitch-turns").value) || 0,
        gauge: r.querySelector(".pitch-gauge").value.trim(),
        weight: parseFloat(r.querySelector(".pitch-weight").value) || 0
      }));

      let imageBase64 = "";
      if (imageInput.files[0]) {
        const file = imageInput.files[0];
        imageBase64 = await new Promise(res => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(file);
        });
      }

      const entry = {
        date: document.getElementById("date").value,
        name: document.getElementById("name").value,
        type: document.getElementById("type").value,
        phase: document.getElementById("phase").value,
        hp: document.getElementById("hp").value,
        kw: document.getElementById("kw").value,
        rpm: document.getElementById("rpm").value,
        startingPitches: getPitchData(startDiv),
        runningPitches: getPitchData(runDiv),
        imageURL: imageBase64
      };

      // Send to Google Sheet
      const resp = await fetch("https://script.google.com/macros/s/AKfycbzBUcV61MY84dF7GivcO4h6gCHcVY_P5qR8oJMXDV3r/dev", {
        method: "POST",
        body: JSON.stringify(entry),
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await resp.json();
      if (data.status === "success") alert("‚úÖ Entry saved to Sheet!");
      else alert("‚ùå Error: " + data.message);

      // Save locally too
      entries.push(entry);
      renderTable(entries);

      // Reset form
      document.getElementById("entryForm").reset();
      startDiv.innerHTML = "";
      runDiv.innerHTML = "";
      addPitch(startDiv);
      addPitch(runDiv);
      preview.src = "";
    };

    function renderTable(data) {
      tableBody.innerHTML = "";
      data.forEach(d => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${d.date}</td>
          <td>${d.name}</td>
          <td>${d.type}</td>
          <td>${d.phase}</td>
          <td>${d.hp}</td>
          <td>${d.kw}</td>
          <td>${d.rpm}</td>
          <td>${d.startingPitches.map(p=>`S:${p.set},T:${p.turns},G:${p.gauge},W:${p.weight}`).join("<br>")}</td>
          <td>${d.runningPitches.map(p=>`S:${p.set},T:${p.turns},G:${p.gauge},W:${p.weight}`).join("<br>")}</td>
          <td>${d.imageURL ? `<img src="${d.imageURL}" width="50">` : ""}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    document.getElementById("exportBtn").onclick = () => {
      if (entries.length === 0) return alert("No entries to export!");
      const rows = entries.map(d => ({
        Date: d.date,
        Name: d.name,
        Type: d.type,
        Phase: d.phase,
        HP: d.hp,
        KW: d.kw,
        RPM: d.rpm,
        Starting_Pitches: d.startingPitches.map(p=>`S:${p.set},T:${p.turns},G:${p.gauge},W:${p.weight}`).join("; "),
        Running_Pitches: d.runningPitches.map(p=>`S:${p.set},T:${p.turns},G:${p.gauge},W:${p.weight}`).join("; "),
        Image: d.imageURL
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "AllEntries");
      XLSX.writeFile(wb, `StatorWinding_${new Date().toISOString().slice(0,10)}.xlsx`);
    };
  </script>
</body>
</html>
